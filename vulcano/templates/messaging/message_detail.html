{% extends 'base.html' %}
{% load static %}

{% block title %}{{ message.subject }} - Vulcano{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    
    <!-- Sidebar -->
    {% include 'dashboard/partials/_sidebar.html' %}
    
    <!-- Main Content -->
    <div class="dashboard-main">
        
        <!-- Toggle Sidebar (móvil) -->
        <button class="sidebar-toggle">
            <i class="bi bi-list"></i>
        </button>
        
        <!-- Header -->
        <div class="dashboard-header">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h1 class="dashboard-title mb-2">
                        <i class="bi bi-envelope-open"></i> {{ message.subject }}
                    </h1>
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        {% if message.recipient == user %}
                        <span class="badge bg-success">
                            <i class="bi bi-arrow-down"></i> Mensaje Recibido
                        </span>
                        {% else %}
                        <span class="badge bg-primary">
                            <i class="bi bi-arrow-up"></i> Mensaje Enviado
                        </span>
                        {% endif %}
                        
                        {% if not message.is_read and message.recipient == user %}
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-envelope-exclamation"></i> Sin Leer
                        </span>
                        {% endif %}
                        
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> {{ message.created_at|date:"d F Y, H:i" }}
                        </small>
                    </div>
                </div>
                
                <div class="btn-group">
                    <a href="{% url 'vulcano:inbox' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                    {% if message.recipient == user %}
                    <a href="{% url 'vulcano:message_compose' %}?recipient={{ message.sender.id }}&reply={{ message.id }}" 
                       class="btn btn-primary">
                        <i class="bi bi-reply"></i> Responder
                    </a>
                    {% endif %}
                    <button type="button" 
                            class="btn btn-outline-danger" 
                            onclick="deleteMessage({{ message.id }})">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Message Content -->
        <div class="row">
            <div class="col-lg-8">
                <div class="dashboard-section">
                    
                    <!-- Message Header -->
                    <div class="d-flex align-items-start gap-3 pb-4 border-bottom mb-4">
                        <!-- Avatar -->
                        <div class="flex-shrink-0">
                            {% if other_user.profile.avatar %}
                            <img src="{{ other_user.profile.avatar.url }}" 
                                 alt="{{ other_user.username }}"
                                 class="rounded-circle"
                                 style="width: 64px; height: 64px; object-fit: cover; border: 3px solid var(--color-primary);">
                            {% else %}
                            <div class="rounded-circle" 
                                 style="width: 64px; height: 64px; background: var(--color-primary-lighter); display: flex; align-items: center; justify-content: center; color: var(--color-primary); border: 3px solid var(--color-primary);">
                                <i class="bi bi-person-circle" style="font-size: 2rem;"></i>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- User Info -->
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="mb-1">
                                        {{ other_user.get_full_name|default:other_user.username }}
                                    </h5>
                                    <p class="text-muted mb-0">
                                        {% if message.recipient == user %}
                                        <strong>De:</strong> {{ message.sender.email }}
                                        {% else %}
                                        <strong>Para:</strong> {{ message.recipient.email }}
                                        {% endif %}
                                    </p>
                                    {% if other_user.profile.company %}
                                    <small class="text-muted">
                                        <i class="bi bi-building"></i> {{ other_user.profile.company }}
                                    </small>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <small class="text-muted d-block">
                                        {{ message.created_at|date:"d/m/Y H:i" }}
                                    </small>
                                    <small class="text-muted">
                                        hace {{ message.created_at|timesince }}
                                    </small>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2 flex-wrap">
                                <span class="badge bg-secondary">
                                    <i class="bi bi-person-badge"></i> {{ other_user.profile.get_role_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Body -->
                    <div class="message-body">
                        <div style="font-size: 1.1rem; line-height: 1.8; color: var(--text-primary);">
                            {{ message.body|linebreaks }}
                        </div>
                    </div>
                    
                    <!-- Actions Footer -->
                    <div class="mt-5 pt-4 border-top">
                        <div class="d-flex gap-2 justify-content-end flex-wrap">
                            {% if message.recipient == user %}
                            <a href="{% url 'vulcano:message_compose' %}?recipient={{ message.sender.id }}&reply={{ message.id }}" 
                               class="btn btn-primary btn-lg">
                                <i class="bi bi-reply me-2"></i> Responder
                            </a>
                            <a href="{% url 'vulcano:message_compose' %}?recipient={{ message.sender.id }}" 
                               class="btn btn-outline-primary btn-lg">
                                <i class="bi bi-envelope me-2"></i> Nuevo Mensaje
                            </a>
                            {% else %}
                            <a href="{% url 'vulcano:message_compose' %}?recipient={{ message.recipient.id }}" 
                               class="btn btn-primary btn-lg">
                                <i class="bi bi-envelope me-2"></i> Enviar otro mensaje
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Info -->
            <div class="col-lg-4">
                
                <!-- Project Info -->
                {% if message.project %}
                <div class="dashboard-section mb-4">
                    <h5 class="mb-3">
                        <i class="bi bi-building me-2"></i> Proyecto Relacionado
                    </h5>
                    
                    <div class="card">
                        {% if message.project.get_main_image %}
                        <img src="{{ message.project.get_main_image.image.url }}" 
                             class="card-img-top" 
                             alt="{{ message.project.title }}"
                             style="height: 200px; object-fit: cover;">
                        {% else %}
                        <div class="card-img-top" 
                             style="height: 200px; background: linear-gradient(135deg, var(--color-primary-lighter), var(--color-primary-light)); display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-building" style="font-size: 3rem; color: var(--color-primary);"></i>
                        </div>
                        {% endif %}
                        
                        <div class="card-body">
                            <span class="badge bg-primary mb-2">
                                {{ message.project.get_category_display }}
                            </span>
                            <h6 class="card-title">{{ message.project.title }}</h6>
                            <p class="card-text small text-muted">
                                {{ message.project.short_description|truncatewords:15 }}
                            </p>
                            <a href="{% url 'vulcano:project_detail' message.project.slug %}" 
                               class="btn btn-outline-primary w-100">
                                <i class="bi bi-eye me-2"></i> Ver Proyecto
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function deleteMessage(messageId) {
        if (confirm('¿Estás seguro de que deseas eliminar este mensaje?')) {
            fetch(`/mensajes/${messageId}/eliminar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = "{% url 'vulcano:inbox' %}";
                }
            });
        }
    }
</script>
{% endblock %}